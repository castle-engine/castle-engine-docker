From 97c8858eb1595bb90a366a7eb35c6ad139f4a779 Mon Sep 17 00:00:00 2001
From: Juha <juha@lazarus-ide.org>
Date: Tue, 30 Jul 2024 10:19:51 +0300
Subject: [PATCH] LCL-GTK2: Fix a crash due to postponed focus loss  Issue
 #28840.

---
 lcl/interfaces/gtk2/gtk2callback.inc | 19 ++++++++++++++-----
 1 file changed, 14 insertions(+), 5 deletions(-)

diff --git a/lcl/interfaces/gtk2/gtk2callback.inc b/lcl/interfaces/gtk2/gtk2callback.inc
index bdc1c39332..3e1d79e3f6 100644
--- a/lcl/interfaces/gtk2/gtk2callback.inc
+++ b/lcl/interfaces/gtk2/gtk2callback.inc
@@ -983,7 +983,7 @@ begin
   {$ENDIF}
   Result:=CallBackDefaultReturn;
 end;
-
+{
 function GtkEntryDelayClearCursorPos(AGtkWidget: Pointer): GBoolean; cdecl;
 var
   Info: PWidgetInfo;
@@ -1006,13 +1006,14 @@ begin
     end;
   end;
 end;
-
+}
 function GTKKillFocusCBAfter({%H-}widget: PGtkWidget; {%H-}event:PGdkEventFocus;
   data: gPointer) : GBoolean; cdecl;
 var
-  Mess : TLMessage;
+  Mess: TLMessage;
   Info: PWidgetInfo;
-  AStart,AEnd: gint;
+  AStart, AEnd: gint;
+  p: Pgchar;
   AForm: TCustomForm;
 {$IFDEF VerboseFocus}
   LCLObject: TObject;
@@ -1071,7 +1072,7 @@ begin
       exit;
     end;
 
-    g_idle_add(@GtkEntryDelayClearCursorPos, Widget);
+    //g_idle_add(@GtkEntryDelayClearCursorPos, Widget);
     //save now CursorPos and SelStart in WidgetInfo
     if (Widget <> nil) then
     begin
@@ -1083,6 +1084,14 @@ begin
           gtk_editable_get_selection_bounds(PGtkEditable(Widget),@AStart, @AEnd);
           Info^.CursorPos := Min(AStart, AEnd);
           Info^.SelLength := Abs(AEnd - AStart);
+          ///
+          // Why clipboard actions when a widget loses focus?
+          {p := gtk_editable_get_chars(PGtkEditable(Widget), AStart, AEnd);
+          if (AStart <> AEnd) then
+            gtk_clipboard_set_text(gtk_clipboard_get(GDK_SELECTION_PRIMARY), p, -1);
+          g_free(p); }
+          gtk_editable_select_region(PGtkEditable(Widget), 0, 0);
+          ///
         end;
       end;
     end;
-- 
2.45.2

